apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: apps
  namespace: argocd
spec:
  description: Application namespaces managed by developers

  # Source repositories
  sourceRepos:
    - {{ .Values.application.git.repoURL }}

  # Allowed destinations
  destinations:
    # Application namespaces
    - namespace: apps-prod-*
      server: {{ .Values.application.destinationServer }}
    - namespace: apps-dev-*
      server: {{ .Values.application.destinationServer }}
    - namespace: apps-ci-*
      server: {{ .Values.application.destinationServer }}

    # Secrets namespace (for DerivedSecret CRDs)
    - namespace: secrets
      server: {{ .Values.application.destinationServer }}

  # Cluster resource whitelist
  clusterResourceWhitelist:
    - group: ''
      kind: Namespace
    # CRDs (for secret-editor and other apps with custom resources)
    - group: apiextensions.k8s.io
      kind: CustomResourceDefinition
    # Cluster RBAC (for apps requiring cluster-wide permissions)
    - group: rbac.authorization.k8s.io
      kind: ClusterRole
    - group: rbac.authorization.k8s.io
      kind: ClusterRoleBinding

  # Namespace resource whitelist (allow resources actually used by apps)
  namespaceResourceWhitelist:
    # Core resources
    - group: ''
      kind: Pod
    - group: ''
      kind: Service
    - group: ''
      kind: ConfigMap
    - group: ''
      kind: Secret
    - group: ''
      kind: ServiceAccount
    - group: ''
      kind: PersistentVolumeClaim

    # Workload resources
    - group: apps
      kind: ReplicaSet
    - group: apps
      kind: Deployment
    - group: apps
      kind: StatefulSet
    - group: apps
      kind: DaemonSet
    - group: batch
      kind: Job
    - group: batch
      kind: CronJob

    # Networking
    - group: networking.k8s.io
      kind: Ingress
    - group: networking.k8s.io
      kind: NetworkPolicy
    - group: networking.zengarden.space
      kind: CompositeIngressHost
    - group: networking.zengarden.space
      kind: PartialIngress

    # Autoscaling and policies
    - group: autoscaling
      kind: HorizontalPodAutoscaler
    - group: policy
      kind: PodDisruptionBudget

    # External Secrets Operator
    - group: external-secrets.io
      kind: ExternalSecret
    - group: external-secrets.io
      kind: SecretStore
    - group: external-secrets.io
      kind: ClusterSecretStore

    # CloudNativePG (CNPG)
    - group: postgresql.cnpg.io
      kind: Cluster
    - group: postgresql.cnpg.io
      kind: Database
    - group: postgresql.cnpg.io
      kind: Backup
    - group: postgresql.cnpg.io
      kind: ScheduledBackup
    - group: postgresql.cnpg.io
      kind: Pooler

    # Victoria Metrics
    - group: operator.victoriametrics.com
      kind: VMServiceScrape
    - group: operator.victoriametrics.com
      kind: VMPodScrape
    - group: operator.victoriametrics.com
      kind: VMRule
    - group: monitoring.coreos.com
      kind: PodMonitor
    - group: monitoring.coreos.com
      kind: ServiceMonitor

    # Custom homelab CRDs
    - group: zengarden.space
      kind: DerivedSecret

    # OSS Derived Secret Operator CRDs
    - group: secrets.oleksiyp.dev
      kind: DerivedSecret
    - group: secrets.oleksiyp.dev
      kind: MasterPassword

    # Secret Editor CRDs
    - group: secreteditor.zengarden.space
      kind: SecretAccessPolicy
    - group: secreteditor.zengarden.space
      kind: AccessGroup
    - group: secreteditor.zengarden.space
      kind: SecretAuditLog
    - group: secreteditor.zengarden.space
      kind: BreakGlassAccess

    # RBAC (for job watchers, etc.)
    - group: rbac.authorization.k8s.io
      kind: Role
    - group: rbac.authorization.k8s.io
      kind: RoleBinding

    # cert-manager
    - group: cert-manager.io
      kind: Certificate
    - group: cert-manager.io
      kind: Issuer

  # Sync windows (optional - can restrict when syncs happen)
  # syncWindows: []

  # Orphaned resources monitoring
  orphanedResources:
    warn: true